# VitaProd Bot 🍓

AI-ассистент для оптовой компании замороженных и сушёных продуктов. Telegram бот с RAG-архитектурой, памятью диалогов и системой оформления заказов.

## Возможности

### Реализовано ✅
- ✅ Консультант **Себастьян Перейра** — дружелюбный AI-ассистент
- ✅ Ответы на вопросы о ценах и наличии товаров
- ✅ Семантический поиск по каталогу (138 товаров в 10 категориях)
- ✅ **Память диалогов** — бот помнит контекст разговора (LangGraph + PostgreSQL)
- ✅ **Система заказов** с пошаговым оформлением:
  - Распознавание намерения заказа из диалога
  - Inline-кнопки для управления заказом
  - Валидация телефона, даты, времени доставки
  - Предупреждение о выходных днях
  - Выбор доставки или самовывоза
  - Экспорт заказа в XLSX
  - Отправка заявки менеджеру в Telegram
- ✅ Эскалация на менеджера при необходимости

### Планируемые 📋
- 📋 Автозаполнение данных для повторных клиентов
- 📋 История заказов клиента
- 📋 Уведомления о статусе заказа
- 📊 Аналитика и отчёты
- 🔗 Интеграция с 1C

## Категории товаров

| Категория | Форма | Примеры |
|-----------|-------|---------|
| Ягоды | Замороженные | Черника, малина, клубника, смородина |
| Овощи | Замороженные | Перец, баклажан, горошек, кукуруза |
| Фрукты | Замороженные | Вишня, абрикос, ананас, гранат |
| Грибы | Замороженные/Сушёные | Белый гриб, лисички, маслята |
| Орехи | Замороженные | Каштан, кедровый орех |
| Плоды | Сушёные | Боярышник, калина, шиповник |
| Травы | Сушёные | Лист смородины |
| Компотные смеси | Замороженные | 10 видов смесей |
| Овощные смеси | Замороженные | Европейская, гавайская и др. |

## Технологии

| Компонент | Технология |
|-----------|------------|
| Telegram Bot | aiogram 3.x + FSM |
| Оркестрация диалогов | LangGraph |
| Память диалогов | PostgreSQL (AsyncPostgresSaver) |
| Vector Database | Qdrant |
| LLM | GigaChat |
| Embeddings | sentence-transformers (multilingual-e5-small) |
| Экспорт заказов | openpyxl |

## Быстрый старт

### 1. Клонирование и настройка

```bash
git clone <your-repo-url>
cd vitaprod_bot

# Создание виртуального окружения
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
.\venv\Scripts\activate  # Windows

# Установка зависимостей
pip install -r requirements.txt
```

### 2. Конфигурация

```bash
# Копируем пример конфигурации
cp .env.example .env
```

Заполните `.env`:

```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token_here
MANAGER_TELEGRAM_ID=123456789  # ID менеджера для получения заказов

# GigaChat
GIGACHAT_CREDENTIALS=your_credentials_here

# PostgreSQL (для памяти диалогов)
POSTGRES_HOST=localhost
POSTGRES_PORT=5433
POSTGRES_USER=vitaprod
POSTGRES_PASSWORD=vitaprod_secret
POSTGRES_DB=vitaprod

# Qdrant
QDRANT_HOST=localhost
QDRANT_PORT=6333
```

### 3. Запуск Docker контейнеров

```bash
docker compose up -d
```

Это запустит:
- **Qdrant** (порт 6333) — векторная база для поиска товаров
- **PostgreSQL** (порт 5433) — хранение диалогов

### 4. Загрузка прайс-листа

```bash
# Загрузка товаров из PDF
python -m scripts.load_price data/prices/price_vitaprod.pdf
```

### 5. Запуск бота

```bash
python -m src.main
```

## Структура проекта

```
vitaprod_bot/
├── src/
│   ├── bot/                    # Telegram бот
│   │   ├── handlers/
│   │   │   ├── start.py        # /start, /clear, кнопки меню
│   │   │   ├── order.py        # FSM оформления заказов
│   │   │   └── price_query.py  # Обработка сообщений
│   │   └── keyboards/
│   │       └── order.py        # Inline-клавиатуры заказов
│   ├── core/
│   │   ├── graph/              # LangGraph (память диалогов)
│   │   │   ├── graph.py        # Граф диалога
│   │   │   ├── nodes.py        # Ноды (retrieve, generate)
│   │   │   └── state.py        # Состояние диалога
│   │   ├── orders/             # Система заказов
│   │   │   ├── models.py       # Order, OrderItem, Customer
│   │   │   ├── states.py       # FSM состояния
│   │   │   ├── validators.py   # Валидация (телефон, дата, время)
│   │   │   ├── exporter.py     # Экспорт в XLSX
│   │   │   └── intent.py       # Распознавание намерения заказа
│   │   ├── rag/                # RAG pipeline
│   │   │   └── retriever.py    # Поиск товаров
│   │   └── prompts.py          # Системные промпты
│   ├── data/
│   │   ├── parsers/
│   │   │   └── pdf_parser.py   # Парсер PDF прайс-листов
│   │   └── embeddings.py       # Сервис эмбеддингов
│   ├── db/
│   │   ├── sqlite.py           # SQLite (legacy)
│   │   └── vector.py           # Qdrant клиент
│   ├── integrations/
│   │   └── llm/                # GigaChat интеграция
│   └── config.py               # Настройки приложения
├── data/
│   ├── prices/                 # PDF прайс-листы
│   └── orders/                 # Экспортированные заказы (XLSX)
├── scripts/
│   ├── load_price.py           # Загрузка прайс-листа
│   └── check_qdrant.py         # Проверка данных в Qdrant
└── docker-compose.yml
```

## Флоу оформления заказа

```
Клиент: Хочу заказать чернику 10 кг
    │
    ▼
┌─────────────────────────────────────┐
│  📦 Оформляем заказ?                │
│  • Черника — 10 кг × 420 ₽ = 4200 ₽ │
│                                     │
│  [Да, оформить] [Добавить] [Отмена] │
└─────────────────────────────────────┘
    │
    ▼ [Да, оформить]
┌─────────────────────────────────────┐
│  🚚 Способ получения                │
│                                     │
│  [Доставка] [Самовывоз]             │
└─────────────────────────────────────┘
    │
    ▼ [Доставка]
┌─────────────────────────────────────┐
│  📍 Введите адрес доставки          │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  📅 Выберите дату                   │
│                                     │
│  [Завтра] [Послезавтра] [Другая]    │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  🕐 Выберите время                  │
│                                     │
│  [Утро] [День] [Вечер] [Любое]      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  👤 Контактные данные               │
│  Имя → Телефон → Компания           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  📋 Проверьте заказ                 │
│  [Подтвердить] [Редактировать]      │
└─────────────────────────────────────┘
    │
    ▼ [Подтвердить]
┌─────────────────────────────────────┐
│  ✅ Заявка #ABC123 принята!         │
│  Менеджер свяжется с вами           │
│                                     │
│  → XLSX отправлен менеджеру         │
└─────────────────────────────────────┘
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие и главное меню |
| `/clear` | Очистить историю диалога |
| `/help` | Справка по использованию |

## Кнопки меню

| Кнопка | Действие |
|--------|----------|
| 📋 Весь ассортимент | Показать все товары по категориям |
| 📞 Связаться с менеджером | Контакты компании |

## Получение токенов

### Telegram Bot Token

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте `/newbot`
3. Следуйте инструкциям
4. Скопируйте токен в `.env`

### Manager Telegram ID

1. Напишите боту [@userinfobot](https://t.me/userinfobot)
2. Он покажет ваш ID
3. Скопируйте в `MANAGER_TELEGRAM_ID`

### GigaChat Credentials

1. Зарегистрируйтесь на [developers.sber.ru](https://developers.sber.ru)
2. Создайте проект и получите credentials
3. Скопируйте в `.env` (формат: base64 от `client_id:client_secret`)

## Полезные команды

```bash
# Проверить данные в Qdrant
python -m scripts.check_qdrant

# Перезагрузить прайс-лист
python -m scripts.load_price data/prices/price_vitaprod.pdf

# Очистить историю диалогов в PostgreSQL
docker exec -it vitaprod_postgres psql -U vitaprod -d vitaprod -c "DELETE FROM checkpoints; DELETE FROM checkpoint_blobs; DELETE FROM checkpoint_writes;"

# Посмотреть логи контейнеров
docker compose logs -f

# Перезапустить контейнеры
docker compose restart
```

## Troubleshooting

### Бот не отвечает
1. Проверьте что Docker контейнеры запущены: `docker compose ps`
2. Проверьте логи бота в терминале
3. Убедитесь что `.env` заполнен корректно

### Ошибка "relation does not exist"
Отправьте любое сообщение боту — таблицы создадутся автоматически при первом запросе.

### Модель не загружается
```bash
# Загрузить embedding модель вручную
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('intfloat/multilingual-e5-small')"
```

### Заказ не приходит менеджеру
1. Проверьте `MANAGER_TELEGRAM_ID` в `.env`
2. Убедитесь что менеджер начал диалог с ботом (отправил `/start`)
3. Проверьте логи на наличие ошибок отправки


